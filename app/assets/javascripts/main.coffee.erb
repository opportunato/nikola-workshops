$ ->
  $window = $(window)
  $body = $("body")
  $kazarma = $(".kazarma")
  $header = $("header")
  $menuButton = $(".menuButton")
  $workshopList = $(".workshopList")
  $overlay = $(".overlay")
  $intro = $(".intro")

  workshopInit = ->
    $carousel = $(".carousel")

    if $carousel.length > 0
      carousel = new Carousel(".carousel")
      carousel.init()

      arrowRight = $('.arrowRight')
      arrowLeft = $('.arrowLeft')

      panes = $('.carousel li.pane')
      pane_count = panes.length;

      current_pane = 0;

      nexthammertime = Hammer(arrowRight[0]).on "tap", (event) ->
          nextCarousel = new Carousel(".carousel")
          nextCarousel.init()
          nextCarousel.showPane(current_pane + 1, true)
          if current_pane < pane_count-1
              current_pane += 1

      previoushammertime = Hammer(arrowLeft[0]).on "tap", (event) ->
          previousCarousel = new Carousel(".carousel")
          previousCarousel.init()
          previousCarousel.showPane(current_pane - 1, true)
          if current_pane > 0
              current_pane -= 1

    if $window.width() > 1024
      $carousel.height vph
    else
      $carousel.height 400

    $(".carousel-image").responsive_images 
      mobile_size: 640,
      tablet_size: 1024,
      desktop_size: 1600

  workshopInit()

  vpw = $window.width()
  vph = $window.height()

  $kazarma.height vph

  # typed.js
  setTimeout ->
    $("#typed").typed
      strings: ["Воркшопы с международными специалистами в уникальной среде Никола-Ленивца."]
      typeSpeed: 10
  , 1200

  $window.resize ->
    vph = $window.height()
    $kazarma.height vph

    if $window.width() > 1024
      $(".carousel").height vph
    else
      $(".carousel").height 400

  # TODO с timeout какой-то грязный хак, не нравится мне это

  $menuButton.on 'click', ->
    $body.toggleClass 'noscroll'

    setTimeout ->
      $header.toggleClass 'opened'
    , 50

  $overlay.on 'click', '.menuButtonPopup', ->

    $overlay.html("")
    $overlay.toggleClass 'opened'

    history.go(-1)

    workshopInit();

    setTimeout ->
      $body.toggleClass 'noscroll'
    , 50

  $workshopList.on 'click', ".workshopWrapper", (e) ->
    id = $(e.currentTarget).data('id')
    $body.toggleClass 'noscroll'

    setTimeout ->
      $overlay.toggleClass 'opened'
    , 50

    history.pushState({}, "", "/workshops/#{id}")

    $.get "/workshops/#{id}.js",
      (data) ->
        $overlay.html(data)
        workshopInit()
      , 'html'
